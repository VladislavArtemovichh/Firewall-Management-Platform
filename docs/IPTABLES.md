# Документация по работе с iptables

## Обзор

В проекте **Firewall Management Platform** реализована система управления правилами iptables для устройств типа OpenWrt. Система предоставляет веб-интерфейс и API для управления блокировкой IP-адресов через iptables.

Iptables является стандартным межсетевым экраном для Linux-систем, который позволяет контролировать сетевой трафик на уровне пакетов. В нашем проекте система автоматизирует процесс управления правилами iptables, предоставляя удобный веб-интерфейс для администраторов.

## Архитектура

### Компоненты системы

Система управления iptables состоит из нескольких ключевых компонентов:

1. **Backend API** (`app/firewall_devices_api.py`) - основной модуль для работы с iptables. Этот компонент обрабатывает все запросы к API, валидирует входные данные и выполняет команды iptables на целевых устройствах.

2. **Frontend** (`templates/rules.html`) - веб-интерфейс для управления правилами. Предоставляет пользовательский интерфейс с формами для добавления блокировок, просмотра существующих правил и управления устройствами.

3. **Логирование** - детальное логирование всех операций. Система ведет подробные логи всех действий с правилами iptables для аудита и отладки.

### Поддерживаемые устройства

Основной платформой для работы с iptables является **OpenWrt** - открытая операционная система для сетевых устройств. OpenWrt предоставляет полную поддержку iptables и является идеальной платформой для реализации межсетевого экрана.

Также система поддерживает другие Linux-системы с установленным iptables, что позволяет использовать её с различными сетевыми устройствами и серверами.

## API Endpoints

### Получение правил iptables

Система предоставляет два основных API для получения информации о правилах iptables:

#### `GET /api/device_ip_rules`
Этот endpoint возвращает список заблокированных IP-адресов из всех цепочек iptables. API анализирует правила в цепочках FORWARD, INPUT и OUTPUT, извлекает IP-адреса из правил DROP и определяет направление блокировки.

**Параметры:**
- `device_id` (int, обязательный) - ID устройства в базе данных
- `direction` (string, опциональный) - фильтр по направлению трафика

**Ответ:**
```json
{
    "device_name": "Router-01",
    "ips": ["192.168.1.100 (входящий)", "10.0.0.5 (исходящий)"],
    "total_count": 2,
    "timestamp": "2024-01-15T10:30:00"
}
```

#### `GET /api/device_iptables_raw`
Этот endpoint предназначен для отладки и возвращает сырые данные iptables без фильтрации. Полезен для диагностики проблем и понимания текущего состояния правил.

**Параметры:**
- `device_id` (int, обязательный) - ID устройства

**Ответ:**
```json
{
    "device_name": "Router-01",
    "all_rules": {
        "FORWARD": ["1 DROP all -- 192.168.1.100 anywhere"],
        "INPUT": ["1 DROP all -- anywhere 192.168.1.100"],
        "OUTPUT": []
    },
    "total_chains": 3,
    "timestamp": "2024-01-15T10:30:00"
}
```

### Управление блокировками

Система предоставляет три основных API для управления блокировками IP-адресов:

#### `POST /api/device_ip_block`
Добавляет новое правило блокировки IP-адреса. API поддерживает блокировку как всего трафика, так и трафика по конкретным портам. Также можно указать направление блокировки: входящий, исходящий или весь трафик.

**Параметры:**
- `device_id` (int, обязательный) - ID устройства
- `request_data` (dict):
  - `ip` (string, обязательный) - IP-адрес для блокировки
  - `port` (string, опциональный) - порт для блокировки
  - `direction` (string, опциональный) - направление: "in", "out", "both"

**Пример запроса:**
```json
{
    "ip": "192.168.1.100",
    "port": "80,443",
    "direction": "both"
}
```

#### `POST /api/device_ip_unblock`
Удаляет правила блокировки для указанного IP-адреса. API автоматически находит все правила DROP, связанные с указанным IP-адресом, и удаляет их из всех цепочек.

**Параметры:**
- `device_id` (int, обязательный) - ID устройства
- `request_data` (dict):
  - `ip` (string, обязательный) - IP-адрес для разблокировки

#### `POST /api/device_ip_clear_all`
Удаляет все правила блокировки IP-адресов. Этот API полезен для полной очистки всех блокировок, например, при смене политики безопасности.

**Параметры:**
- `device_id` (int, обязательный) - ID устройства

## Логика работы с iptables

### Цепочки (Chains)

Iptables использует систему цепочек для организации правил. Система работает с тремя основными цепочками:

- **FORWARD** - для трафика, проходящего через устройство. Эта цепочка обрабатывает пакеты, которые не предназначены для самого устройства, но проходят через него (например, трафик между локальной сетью и интернетом).

- **INPUT** - для входящего трафика к устройству. Эта цепочка обрабатывает пакеты, которые направлены непосредственно на устройство (например, SSH-подключения к роутеру).

- **OUTPUT** - для исходящего трафика от устройства. Эта цепочка обрабатывает пакеты, которые исходят от самого устройства.

### Типы блокировок

Система поддерживает два основных типа блокировок:

#### 1. Блокировка всего трафика
При выборе этого типа система создает правила, которые блокируют весь трафик для указанного IP-адреса во всех направлениях. Это наиболее строгий тип блокировки, который полностью изолирует IP-адрес от сети.

Для входящего трафика создаются правила в цепочках FORWARD и INPUT, которые отбрасывают все пакеты, направленные к заблокированному IP-адресу.

Для исходящего трафика создаются правила в цепочках FORWARD и OUTPUT, которые отбрасывают все пакеты, исходящие от заблокированного IP-адреса.

#### 2. Блокировка по портам
Этот тип блокировки позволяет более точно контролировать трафик, блокируя только определенные порты или протоколы. Например, можно заблокировать только веб-трафик (порты 80 и 443), оставив доступными другие сервисы.

Блокировка по портам создает более специфичные правила, которые проверяют не только IP-адрес, но и номер порта в заголовке пакета.

### Валидация IP-адресов

Система включает строгую валидацию IP-адресов для обеспечения безопасности и корректности работы:

1. **Формат проверка** - система принимает только числовые IP-адреса в формате xxx.xxx.xxx.xxx. Это исключает возможность ввода некорректных данных.

2. **DNS-имена запрещены** - система не принимает доменные имена. Это связано с тем, что iptables работает на уровне IP-адресов, а не доменных имен.

3. **Служебные IP исключены** - система автоматически исключает служебные IP-адреса, такие как 0.0.0.0, 127.0.0.1, 255.255.255.255, 224.0.0.0, которые могут быть использованы для специальных целей.

### Парсинг правил

Для извлечения информации из вывода команд iptables система использует регулярные выражения. Это позволяет автоматически анализировать правила и определять:

- IP-адреса, которые заблокированы
- Направление блокировки (входящий или исходящий трафик)
- Порты, если указаны
- Комментарии к правилам

Система определяет направление блокировки на основе анализа цепочки и содержимого правила. Например, если IP-адрес указан как destination (-d), то это входящий трафик, если как source (-s), то исходящий.

## Логирование

### Уровни логирования

Система использует различные уровни логирования для отслеживания операций:

- **INFO** - успешные операции, такие как добавление или удаление правил
- **ERROR** - ошибки выполнения команд iptables, проблемы с валидацией данных
- **WARNING** - предупреждения, например, когда IP-адрес не найден в правилах

### Форматы логов

Логи содержат подробную информацию о каждой операции, включая:
- Время выполнения операции
- Тип операции (добавление, удаление, просмотр)
- IP-адрес и параметры
- Результат выполнения
- Любые ошибки или предупреждения

## Веб-интерфейс

### Основные функции

Веб-интерфейс предоставляет удобный способ управления правилами iptables без необходимости использования командной строки:

1. **Выбор устройства** - dropdown с доступными устройствами из базы данных
2. **Ввод IP-адреса** - текстовое поле с валидацией в реальном времени
3. **Указание порта** - опциональное поле для блокировки по портам
4. **Выбор направления** - dropdown с опциями: весь трафик, входящий, исходящий
5. **Кнопки действий**:
   - Заблокировать IP - добавляет новое правило блокировки
   - Показать заблокированные - отображает текущие правила
   - Удалить все блокировки - очищает все правила блокировки

### Пользовательский опыт

Интерфейс спроектирован с учетом удобства использования:
- Валидация данных в реальном времени
- Подтверждение критических операций
- Визуальная обратная связь о статусе операций
- Подробные сообщения об ошибках

## Обработка ошибок

### Типичные ошибки

Система обрабатывает различные типы ошибок:

1. **Device not found** - устройство не найдено в базе данных
2. **Device type does not support IP blocking** - неподдерживаемый тип устройства
3. **Invalid IP address format** - неверный формат IP-адреса
4. **DNS names are not allowed** - попытка использовать доменное имя
5. **Permission denied** - недостаточно прав для выполнения команд iptables
6. **Command execution failed** - ошибка выполнения команды iptables

### Стратегии восстановления

Для обеспечения надежности системы используются следующие стратегии:

1. **Повторные попытки** - для критических операций система может повторить попытку при временных ошибках
2. **Graceful degradation** - при частичных сбоях система продолжает работать с ограниченной функциональностью
3. **Валидация команд** - проверка синтаксиса команд перед выполнением для предотвращения ошибок

## Тестирование

### Unit тесты

Система включает полный набор unit тестов, которые проверяют:

- Корректность работы API endpoints
- Валидацию входных данных
- Обработку ошибок
- Парсинг правил iptables
- Интеграцию с базой данных

Тесты используют mock объекты для имитации внешних зависимостей, что позволяет тестировать логику без реальных сетевых подключений.

### Mock объекты

Тесты используют mock объекты для имитации:
- Вывода команд iptables
- Базы данных устройств
- Выполнения команд

Это обеспечивает изоляцию тестов и позволяет тестировать компоненты независимо друг от друга.

## Безопасность

### Валидация входных данных

Система включает многоуровневую валидацию входных данных:

1. **IP-адреса** - строгая проверка формата и исключение служебных адресов
2. **Порты** - проверка диапазона (1-65535) и валидация синтаксиса
3. **Направления** - только разрешенные значения для предотвращения инъекций
4. **SQL Injection** - использование параметризованных запросов для работы с базой данных

### Безопасность команд iptables

Для обеспечения безопасности при выполнении команд iptables:

1. **Валидация команд** - проверка синтаксиса перед выполнением
2. **Ограничение прав** - выполнение команд с минимальными привилегиями
3. **Логирование** - запись всех операций для аудита и расследования инцидентов

## Производительность

### Оптимизации

Система включает несколько оптимизаций для повышения производительности:

1. **Батчевые операции** - группировка команд iptables для уменьшения накладных расходов
2. **Асинхронность** - неблокирующие операции для улучшения отзывчивости
3. **Кэширование результатов** - переиспользование данных для уменьшения количества запросов

### Мониторинг

Система отслеживает различные метрики производительности:

1. **Время выполнения команд** - отслеживание производительности операций
2. **Количество правил** - статистика по устройствам для планирования ресурсов
3. **Частота операций** - метрики использования для оптимизации

## Примеры использования

### Блокировка подозрительного IP

Один из наиболее частых сценариев использования - блокировка IP-адреса, который проявляет подозрительную активность. Система позволяет быстро заблокировать такой IP-адрес во всех направлениях.

### Блокировка веб-трафика

Для более точного контроля можно заблокировать только веб-трафик (HTTP/HTTPS) для определенного IP-адреса, оставив доступными другие сервисы, такие как почта или файловый обмен.

### Просмотр заблокированных IP

Регулярный мониторинг заблокированных IP-адресов помогает администраторам понимать текущее состояние безопасности сети и принимать решения о необходимости изменения правил.

## Заключение

Система управления iptables в проекте предоставляет полный набор инструментов для:

- **Блокировки IP-адресов** по различным критериям с поддержкой гибкой настройки
- **Мониторинга и аудита правил** для обеспечения прозрачности операций
- **Веб-интерфейса** для удобного управления без необходимости использования командной строки
- **API для интеграции** с другими системами безопасности и мониторинга

Система спроектирована с учетом современных требований к безопасности, производительности и надежности, что делает её пригодной для использования в производственной среде. Архитектура системы обеспечивает масштабируемость и возможность расширения функциональности в будущем. 