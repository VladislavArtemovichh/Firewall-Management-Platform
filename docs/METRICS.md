# Система метрик Firewall Management Platform

## Обзор

Система метрик предоставляет администраторам детальную информацию о производительности и безопасности платформы управления брандмауэрами. Доступ к метрикам имеют только пользователи с ролью "firewall-admin".

## Возможности

### Системные метрики
- **CPU**: Текущее и среднее использование процессора
- **Память**: Использование оперативной памяти
- **Диск**: Использование дискового пространства
- **Сеть**: Переданные и полученные данные

### Метрики приложения
- **Активные пользователи**: Количество пользователей в системе
- **Запросы**: Общее количество запросов и ошибок
- **Время ответа**: Среднее время обработки запросов
- **Правила брандмауэра**: Количество активных правил
- **Сессии**: Количество активных пользовательских сессий

### Метрики безопасности
- **Неудачные попытки входа**: Количество неудачных попыток аутентификации
- **Заблокированные IP**: Количество заблокированных IP-адресов
- **Подозрительная активность**: События безопасности
- **Блокировки брандмауэра**: Количество блокировок

## Доступ к метрикам

### Веб-интерфейс
1. Войдите в систему как администратор (роль "firewall-admin")
2. В боковом меню появится пункт "Метрики системы"
3. Перейдите на страницу `/metrics`

### API endpoints

#### Получение сводки метрик
```
GET /api/metrics/summary
```
Возвращает сводку всех метрик за последние 24 часа.

#### Получение данных для графиков
```
GET /api/metrics/charts
```
Возвращает данные для построения графиков.

#### Запись метрик запроса
```
POST /api/metrics/record-request
```
Параметры:
- `response_time`: Время ответа в секундах
- `is_error`: true/false - является ли запрос ошибкой

#### Запись метрик безопасности
```
POST /api/metrics/record-security
```
Параметры:
- `event_type`: Тип события (failed_login, suspicious_activity, firewall_block)
- `ip_address`: IP-адрес (для failed_login)

## Автоматический сбор метрик

Система автоматически собирает метрики:

1. **Системные метрики**: Каждые 30 секунд
2. **Метрики запросов**: При каждом HTTP-запросе
3. **Метрики безопасности**: При событиях безопасности

## Интерфейс

### KPI карточки
- Отображают текущие значения ключевых показателей
- Показывают средние значения за период
- Цветовая индикация состояния

### Графики
- **Системные ресурсы**: График использования CPU, памяти и диска
- **Активность приложения**: График активных пользователей и времени ответа

### Автообновление
- Данные обновляются каждые 30 секунд
- Кнопка "Обновить" для принудительного обновления

## Установка зависимостей

Добавьте в `requirements.txt`:
```
psutil==5.9.8
```

Установите зависимости:
```bash
pip install -r requirements.txt
```

## Конфигурация

### Настройка сбора метрик
В файле `app/metrics.py` можно настроить:
- `max_history`: Максимальное количество сохраняемых метрик (по умолчанию 1000)
- Интервал сбора системных метрик (по умолчанию 30 секунд)

### Настройка доступа
Доступ к метрикам контролируется в `app/routes.py`:
- Проверка роли пользователя
- Перенаправление неавторизованных пользователей

## Мониторинг

### Логи
Система метрик записывает ошибки в консоль:
- Ошибки сбора системных метрик
- Ошибки записи метрик запросов
- Ошибки записи метрик безопасности

### Производительность
- Сбор метрик происходит асинхронно
- Не влияет на производительность основного приложения
- Автоматическая очистка старых данных

## Безопасность

- Доступ только для администраторов
- Проверка ролей на уровне API
- Защита от несанкционированного доступа
- Логирование всех попыток доступа

## Расширение

Для добавления новых метрик:

1. Добавьте новые поля в классы метрик в `app/metrics.py`
2. Создайте методы сбора новых метрик
3. Обновите API endpoints
4. Добавьте отображение в веб-интерфейсе

## Устранение неполадок

### Метрики не отображаются
1. Проверьте, что пользователь имеет роль "firewall-admin"
2. Убедитесь, что psutil установлен
3. Проверьте логи на наличие ошибок

### Ошибки сбора метрик
1. Проверьте права доступа к системным ресурсам
2. Убедитесь, что приложение запущено с достаточными правами
3. Проверьте доступность дискового пространства

### Графики не обновляются
1. Проверьте JavaScript консоль браузера
2. Убедитесь, что API endpoints доступны
3. Проверьте сетевые настройки 