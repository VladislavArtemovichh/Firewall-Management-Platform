# Rate Limiting

## Обзор

Rate Limiting (ограничение частоты запросов) - это механизм защиты API от злоупотреблений, который ограничивает количество запросов от одного клиента в определенный период времени.

## Конфигурации

### Типы лимитов

| Тип | Максимум запросов | Временное окно | Описание |
|-----|-------------------|----------------|----------|
| **default** | 100 | 60 секунд | Общий лимит для всех endpoints |
| **auth** | 5 | 5 минут | Строгий лимит для аутентификации |
| **api** | 1000 | 1 час | Лимит для API endpoints |
| **admin** | 1000 | 60 секунд | Лимит для административных функций |
| **monitoring** | 10 | 60 секунд | Лимит для мониторинга |

### Автоматическое определение

Система автоматически определяет тип лимита по пути endpoint:

- `/auth/*` → **auth** (строгий лимит)
- `/api/*` → **api** (высокий лимит)
- `/admin/*` → **admin** (высокий лимит)
- `/metrics/*` или `/monitoring/*` → **monitoring** (низкий лимит)
- Остальные → **default** (стандартный лимит)

## Использование

### 1. Автоматический Rate Limiting

Все endpoints автоматически защищены Rate Limiting. Система использует:
- **IP адрес** для неавторизованных пользователей
- **User ID** для авторизованных пользователей

### 2. Заголовки ответа

Каждый ответ содержит заголовки Rate Limiting:

```
X-RateLimit-Limit: 100
X-RateLimit-Remaining: 95
X-RateLimit-Reset: 1640995200
```

### 3. Ошибка превышения лимита

При превышении лимита возвращается ошибка 429:

```json
{
  "error": "Too Many Requests",
  "message": "Превышен лимит запросов. Попробуйте позже.",
  "retry_after": 45,
  "rate_limit_info": {
    "limit": 100,
    "remaining": 0,
    "reset": 1640995200,
    "reset_time": "2022-01-01T12:00:00",
    "current_requests": 100
  }
}
```

## API Endpoints

### Получить статистику Rate Limiting

```http
GET /api/rate-limit/stats
```

**Ответ:**
```json
{
  "total_keys": 5,
  "stats": {
    "rate_limit:auth:user:1": {
      "current_requests": 3,
      "ttl_seconds": 240,
      "expires_at": "2022-01-01T12:04:00"
    }
  },
  "configs": {
    "default": {
      "max_requests": 100,
      "window_seconds": 60,
      "description": "Общий лимит для всех endpoints"
    }
  }
}
```

### Сбросить все Rate Limits

```http
DELETE /api/rate-limit/reset
```

**Ответ:**
```json
{
  "message": "Сброшено 5 Rate Limits",
  "reset_keys": [
    "rate_limit:auth:user:1",
    "rate_limit:api:ip:192.168.1.100"
  ]
}
```

## Техническая реализация

### Redis

Rate Limiting использует Redis для хранения счетчиков:

- **Ключи:** `rate_limit:{type}:{identifier}:{value}`
- **Структура:** Sorted Set с временными метками
- **TTL:** Автоматическое удаление по истечении окна

### Алгоритм

1. **Получение ключа:** IP адрес или User ID
2. **Очистка старых запросов:** Удаление запросов вне окна
3. **Добавление текущего запроса:** Временная метка
4. **Подсчет запросов:** Количество в окне
5. **Проверка лимита:** Сравнение с максимальным значением

### Пример ключей Redis

```
rate_limit:auth:user:1
rate_limit:api:ip:192.168.1.100
rate_limit:default:ip:10.0.0.1
```

## Настройка

### Изменение конфигураций

Отредактируйте `RATE_LIMIT_CONFIGS` в `app/rate_limiting.py`:

```python
RATE_LIMIT_CONFIGS = {
    "custom": {
        "max_requests": 50,
        "window_seconds": 300,
        "description": "Кастомный лимит"
    }
}
```

### Redis URL

По умолчанию используется `redis://localhost:6379`. Для изменения:

```python
rate_limiter = RateLimiter("redis://your-redis-server:6379")
```

## Мониторинг

### Логи

Rate Limiting логирует ошибки подключения к Redis:

```
Rate Limiting error: Connection refused
```

### Метрики

Можно добавить метрики для мониторинга:

- Количество заблокированных запросов
- Среднее количество запросов по IP
- Топ IP адресов по запросам

## Безопасность

### Защита от обхода

- **User ID приоритет:** Авторизованные пользователи идентифицируются по ID
- **IP fallback:** Неавторизованные пользователи по IP
- **Redis TTL:** Автоматическая очистка старых данных

### Graceful degradation

При недоступности Redis:
- Rate Limiting отключается
- Запросы обрабатываются нормально
- Логируется ошибка

## Примеры

### Тестирование Rate Limiting

```bash
# Быстрые запросы для тестирования
for i in {1..110}; do
  curl -X GET "http://localhost:8000/api/firewall-rules"
done
```

### Мониторинг через API

```bash
# Получить статистику
curl -X GET "http://localhost:8000/api/rate-limit/stats"

# Сбросить лимиты (только для админов)
curl -X DELETE "http://localhost:8000/api/rate-limit/reset"
```

### Проверка заголовков

```bash
curl -I -X GET "http://localhost:8000/api/firewall-rules"
```

**Ответ:**
```
HTTP/1.1 200 OK
X-RateLimit-Limit: 1000
X-RateLimit-Remaining: 999
X-RateLimit-Reset: 1640995200
```

## Рекомендации

### Продакшен

1. **Redis кластер:** Используйте Redis кластер для высокой доступности
2. **Мониторинг:** Настройте алерты на превышение лимитов
3. **Логирование:** Логируйте заблокированные запросы
4. **Метрики:** Добавьте метрики в Prometheus

### Разработка

1. **Локальный Redis:** Установите Redis для разработки
2. **Тестирование:** Протестируйте все типы лимитов
3. **Документация:** Обновите API документацию

## Устранение проблем

### Redis недоступен

```
Rate Limiting error: Connection refused
```

**Решение:**
1. Проверьте, что Redis запущен
2. Проверьте URL подключения
3. Проверьте сетевую доступность

### Высокая нагрузка

**Симптомы:**
- Много ошибок 429
- Медленные ответы

**Решение:**
1. Увеличьте лимиты в конфигурации
2. Добавьте больше Redis серверов
3. Оптимизируйте алгоритм Rate Limiting 